{% extends "index.html" %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <title>cabinet</title>
    <link rel="stylesheet" href="{{ url_for("static", filename="css/style.css") }}">
    <link rel="shortcut icon" type="image/x-icon" href="{{ url_for("static", filename="") }}favicon_{{ current_day }}.png" id="favicon">
    <meta name="viewport" content="width=400" charset="UTF-8" />
</head>
<body>

    <div id="statusbar" class="">Processing...</div>

    <div class="header">


    <ul class="calendar-header">
        {% for weekday_header in weekdays_headers %}
            <li class="weekday-header">{{ weekday_header }}</li>
        {% endfor %}
    </ul>

    <ul class="calendar" id="calendar">
        {% for day in month_days %}
            <li
                {% if day.month != month %}
                    class="day othermonth"
                {% else %}
                    class="day"
                {% endif %}
                data-year="{{ day.year }}"
                data-month="{{ day.month }}"
                data-day="{{ day.day }}">

                {% if day.day == current_day and day.month == current_month and day.year == current_year %}
                        <span class="daynumber-current">
                {% else %}
                        <span class="daynumber">
                {% endif %}
                {{ day.day }}</span>
                <ul class="tasks">
                    {% if day.month|string in tasks and day.day|string in tasks[day.month|string] %}
                        {% for task in tasks[day.month|string][day.day|string]|sort(attribute="start_time") %}
                            <li
                                {% if day.month != month %}
                                    class="task greyed"
                                {% else %}
                                    class="task"
                                    style="background-color:{{ task["color"] }}"
                                {% endif %}
                                data-year="{{ day.year }}"
                                data-month="{{ day.month }}"
                                data-day="{{ day.day }}"
                                data-id="{{ task["id"] }}"
                                {% if "repetition_type" in task %}data-recurrent="1"{% endif %}>

                                {% if not task["is_all_day"] %}
                                    <span class="time">{{ task["start_time"] }}{% if task["start_time"] != task["end_time"] %} - {{ task["end_time"] }}{% endif %}</span>
                                {% endif %}
                                {{ task["title"] }}
                                <p class="accordion-hidden">
                                    {{ task["details"]}}

                                </p>
                            </li>
                        {% endfor %}
                    {% endif %}
                </ul>
            </li>
        {% endfor %}
    </ul>

<script type="text/javascript">
    var smallScreen = (Math.min(document.documentElement.clientWidth, window.innerWidth || 0) <= 650),
        moving = false,
        capturedMovementOffset = false,
        movingElement,
        movingTimeout,
        clicksCounter = 0,
        clicksTimeout;

    function ToggleDetails(target) {
        target.className = target.className === "accordion-hidden" ? "accordion-visible" : "accordion-hidden";
    };

    function ShowStatusbar() {
        document.getElementById("statusbar").className = "processing";
    };

    function HideStatusbar() {
        document.getElementById("statusbar").className = "";
    }

    function SetErrorStatusbar() {
        var statusbar = document.getElementById("statusbar");
        statusbar.innerHTML = "The action errored";
        statusbar.className = "error";
    };



    function readViewPastTasksSetting() {
        var targetName = "ViewPastTasks",
            allCookies = document.cookie.split(';');
        for(var i=0; i < allCookies.length; i++) {
            var cookie = allCookies[i];
            if (cookie.indexOf(targetName) > -1) {
                return cookie.substring(targetName.length + 1, cookie.length) !== "0";
            }
        }
        return true;
    };

    function ToggleViewPastTasks() {
        var expirationDate = new Date(),
            currentSetting = readViewPastTasksSetting();

        expirationDate.setTime(expirationDate.getTime() + 31536000000);
        document.cookie = "ViewPastTasks=" + (currentSetting ? "0" : "1") +
                          "; expires=" + expirationDate.toUTCString() + "; path=/";
        location.reload();
    };



    function resetMovingTimeout() {
        window.clearTimeout(movingTimeout);
        movingTimeout = undefined;
    };

    var hiddenValue, visibilityChangeEventName;
    if (typeof document.hidden !== "undefined") {
        hiddenValue = "hidden";
        visibilityChangeEventName = "visibilitychange";
    } else if (typeof document.msHidden !== "undefined") {
        hiddenValue = "msHidden";
        visibilityChangeEventName = "msvisibilitychange";
    } else if (typeof document.webkitHidden !== "undefined") {
        hiddenValue = "webkitHidden";
        visibilityChangeEventName = "webkitvisibilitychange";
    }

    if (!smallScreen) {
        document.getElementById("calendar").onmousedown = function(eventData) {
            if (eventData.target.nodeName === "LI" && eventData.target.className === "task" &&
                !eventData.target.hasAttribute("data-recurrent")) {

                moving = true;
                movingElement = eventData.target;
                movingElement.onmouseup = DragEnd;
                movingElement.onmousemove = Dragging;
                movingElement.style.width = movingElement.clientWidth - 12 + "px";
                movingElement.style.position = "absolute";
            }
            return;
        };
    }

    document.getElementById("calendar").onclick = function(eventData) {
        if (eventData.target.nodeName === "LI" && eventData.target.className === "day") {
            if (++clicksCounter == 1) {
                // Single click behaviour (nothing)
                clicksTimeout = setTimeout(function() { clicksCounter = 0; }, 300);
            } else {
                clearTimeout(clicksTimeout);
                clicksCounter = 0;
            }
            return;
        }

        if (eventData.target.nodeName === "LI" && eventData.target.className === "task") {
            // If is not "all day" there will be a span containing the time before the content
            ToggleDetails(eventData.target.children[eventData.target.children.length - 1]);
            return;
        } else if (eventData.target.nodeName === "SPAN" && eventData.target.parentNode.nodeName === "LI"
                    && eventData.target.parentNode.className === "task") {
            // If is not "all day" there will be a span containing the time before the content
            ToggleDetails(eventData.target.parentNode.children[eventData.target.parentNode.children.length - 1]);
            return;
        }

        if (eventData.target.nodeName === "P" && (eventData.target.className === "accordion-hidden" ||
                                                    eventData.target.className === "accordion-visible")) {
            ToggleDetails(eventData.target);
            return;
        }

        if (eventData.target.nodeName === "A") {
            if (eventData.target.className.indexOf("remove-task") > -1) {
                DeleteTask(eventData.target.getAttribute("data-year"),
                        eventData.target.getAttribute("data-month"),
                        eventData.target.getAttribute("data-day"),
                        eventData.target.getAttribute("data-id"),
                        eventData.target.getAttribute("data-title"));
            } else {
                if (eventData.target.className.indexOf("hide-recurrent-task") > -1) {
                    DeleteTaskOcurrence(eventData.target.getAttribute("data-year"),
                                    eventData.target.getAttribute("data-month"),
                                    eventData.target.getAttribute("data-day"),
                                    eventData.target.getAttribute("data-id"),
                                    eventData.target.getAttribute("data-title"));
                }
            }
        }

        return;
    };
</script>
</body>
</html>

</script>
</body>
{% endblock %}
